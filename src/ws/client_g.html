<html>
<head>
  <title>Simple client</title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>  

</head>
<body onload="init();">
   <div id="table_div"></div>
   <button id="change-btn">change columns</button>
   <button id="test-btn">test</button>
  <form onsubmit="onSubmit(); return false;">
    <input type="text" id="input">
    <input type="submit" value="Send">
    <button onclick="onCloseClick(); return false;">close</button>
  </form>
  <div id="log"></div>
  <script>
	$('#test-btn').click(function(){
		alert('hereee');
	});  
	
	var view = null;
	var data = null;
	var table= null;   
        var options = {sortColumn:1, showRowNumber: true, width: '100%', height: '100%'}; 	
	   //google.charts.load('current', {'packages':['table']});
	   google.load("visualization", "1.1", {packages:["corechart", 'table','gauge']});
	   google.setOnLoadCallback(drawTable);
	
	$('#change-btn').click(function(){
	    //document.getElementById('change-btn').onclick=function() {
	      
	  	  var m = data.getNumberOfRows();
	      var n = data.getNumberOfColumns();
	  	  data.setCell(0,0, data.getNumberOfRows());
	      data.setCell(0,1,data.getNumberOfColumns());
	      data.setCell(0,2, getRandomInt(0, data.getNumberOfRows()));
	      data.setCell(0,3, getRandomInt(0, data.getNumberOfColumns()));
	      data.setCell(getRandomInt(0, data.getNumberOfRows()), 
	      						 getRandomInt(0, data.getNumberOfColumns()), 999);
	      for (var i = 0; i < m; i++){
	      	for (var j=0; j < n; j++){
	        		data.setCell(i,j, getRandomInt(1000, 5000));
	        }
	      }
	      table.draw(data);
	  	});     
	
	
	
	function setValueAtRandomCell(value){
		data.setCell(getRandomInt(0, data.getNumberOfRows()-1), 
			getRandomInt(0, data.getNumberOfColumns()-1), value);
		table.draw(data);
	}
	
	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
	
	   
	function drawTable() {
	 
	    	   data= new google.visualization.DataTable(

 {"rows": [{"c": [{"v": null}, {"v": 0}, {"v": -1.0}, {"v": -1.0}, {"v": 0}, {"v": 0.10314003859558614}, {"v": 0.7826350260448144}, {"v": -0.8130331453280795}, {"v": 23200.0}, {"v": 199.0}, {"v": 13}, {"v": 200.0}, {"v": 203.0}, {"v": 9}, {"v": 0.1287553281467331}, {"v": -0.25764241296227725}, {"v": -3.9381700903769823}]}, {"c": [{"v": null}, {"v": 5}, {"v": 897.0}, {"v": 937.0}, {"v": 5}, {"v": 0.08665033676603795}, {"v": 0.7518657873829434}, {"v": -0.6491859913057388}, {"v": 23400.0}, {"v": 246.0}, {"v": 8}, {"v": 249.0}, {"v": 252.0}, {"v": 13}, {"v": 0.12467434512421184}, {"v": -0.30878588256514583}, {"v": -4.234706968036659}]}, {"c": [{"v": null}, {"v": 5}, {"v": 756.0}, {"v": 796.0}, {"v": 5}, {"v": 0.06917053429732452}, {"v": 0.7065398873108217}, {"v": -0.4568940724016388}, {"v": 23600.0}, {"v": 307.0}, {"v": 13}, {"v": 308.0}, {"v": 310.0}, {"v": 4}, {"v": 0.12166656748142592}, {"v": -0.3681170702764589}, {"v": -4.515692106261017}]}, {"c": [{"v": 668.0}, {"v": 8}, {"v": 643.0}, {"v": 651.0}, {"v": 15}, {"v": 0.15305605752615425}, {"v": 0.551878304534173}, {"v": -3.783418388352659}, {"v": 23800.0}, {"v": 370.0}, {"v": 13}, {"v": 377.0}, {"v": 380.0}, {"v": 4}, {"v": 0.11601208353248117}, {"v": -0.43234383475205207}, {"v": -4.626457472864576}]}, {"c": [{"v": 536.0}, {"v": 8}, {"v": 524.0}, {"v": 540.0}, {"v": 15}, {"v": 0.14488937693281984}, {"v": 0.496787463346073}, {"v": -3.6799128088230453}, {"v": 24000.0}, {"v": 454.0}, {"v": 13}, {"v": 459.0}, {"v": 463.0}, {"v": 4}, {"v": 0.11243933205263512}, {"v": -0.5040128056340836}, {"v": -4.709556903241067}]}, {"c": [{"v": 433.0}, {"v": 5}, {"v": 422.0}, {"v": 426.0}, {"v": 4}, {"v": 0.14133844893390238}, {"v": 0.4384634388814806}, {"v": -3.635465401601853}, {"v": 24200.0}, {"v": 545.0}, {"v": 8}, {"v": 554.0}, {"v": 559.0}, {"v": 4}, {"v": 0.10680389782080972}, {"v": -0.5813432653714156}, {"v": -4.609331667196781}]}, {"c": [{"v": 339.0}, {"v": 13}, {"v": 333.0}, {"v": 336.0}, {"v": 4}, {"v": 0.13701853367669384}, {"v": 0.3782401877904869}, {"v": -3.4689303296964726}, {"v": 24400.0}, {"v": 663.0}, {"v": 8}, {"v": 664.0}, {"v": 669.0}, {"v": 4}, {"v": 0.10412411926510369}, {"v": -0.6579560810486558}, {"v": -4.478018972534759}]}, {"c": [{"v": 263.0}, {"v": 13}, {"v": 258.0}, {"v": 261.0}, {"v": 9}, {"v": 0.13426029637185147}, {"v": 0.3198261486390377}, {"v": -3.2585790706722135}, {"v": 24600.0}, {"v": 808.0}, {"v": 5}, {"v": 770.0}, {"v": 810.0}, {"v": 5}, {"v": 0.1050354544615176}, {"v": -0.7238166080971229}, {"v": -4.352834698986921}]}, {"c": [{"v": 201.0}, {"v": 8}, {"v": 197.0}, {"v": 199.0}, {"v": 9}, {"v": 0.13217043393596928}, {"v": 0.2649097174462373}, {"v": -2.989063157888885}, {"v": 24800.0}, {"v": null}, {"v": 5}, {"v": 909.0}, {"v": 949.0}, {"v": 5}, {"v": NaN}, {"v": NaN}, {"v": NaN}]}], "cols": [{"type": "number", "id": "last", "label": "last"}, {"type": "number", "id": "bidq", "label": "bidq"}, {"type": "number", "id": "bid", "label": "bid"}, {"type": "number", "id": "ask", "label": "ask"}, {"type": "number", "id": "askq", "label": "askq"}, {"type": "number", "id": "ivol", "label": "ivol"}, {"type": "number", "id": "delta", "label": "delta"}, {"type": "number", "id": "theta", "label": "theta"}, {"type": "number", "id": "strike", "label": "strike"}, {"type": "number", "id": "last", "label": "last"}, {"type": "number", "id": "bidq", "label": "bidq"}, {"type": "number", "id": "bid", "label": "bid"}, {"type": "number", "id": "ask", "label": "ask"}, {"type": "number", "id": "askq", "label": "askq"}, {"type": "number", "id": "ivol", "label": "ivol"}, {"type": "number", "id": "delta", "label": "delta"}, {"type": "number", "id": "theta", "label": "theta"}]}
	    	     
	
	   
	   );



	
	   table = new google.visualization.Table(document.getElementById('table_div'));
	   table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
	 }
	   

    var ws;
	
	
	
    
    function init() {

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:9001/");
   
      // Set event handlers.
      ws.onopen = function() {
        output("onopen");
        ws.send(JSON.stringify({'request_for': 'init_data_table', 'request_handler': ''}));
      };
      
      ws.onmessage = function(e) {
        // e.data contains received string.
        
        //output("onmessage: " + e.data);
        d1=  JSON.parse(e.data);
        if (d1.event == "event_tm_table_structure_changed"){

			console.log(d1);
			data = new google.visualization.DataTable(d1.value);
			view = new google.visualization.DataView(data);
			/*view.setRows(view.getFilteredRows([{column: 14, test: function(value, row, column, table) {
        return (value == 'HSI' || value == 'MHI') 
    }}]));*/
			table.draw(view, options);
			output('number of rows: ' + data.getNumberOfRows());
           
        } else if (d1.event == 'event_tm_table_row_updated'){

			console.log(d1.value);
			for (var c=0; c < d1.value.row_values.length; c++){
				data.setCell(d1.value.row, c, d1.value.row_values[c]["v"]);

			}
			table.draw(view, options);
//			table.draw(data);           
//        	setValueAtRandomCell(getRandomInt(1000, 5000));
        }
        
      };
      
      ws.onclose = function() {
        output("onclose");
      };

      ws.onerror = function(e) {
        output("onerror");
        console.log(e)
      };

    }
    
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }
    
    function onCloseClick() {
      ws.close();
    }
    
    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      log.innerHTML = escaped + "<br>" + log.innerHTML;
    }
	 
  </script>
</body>
</html>
