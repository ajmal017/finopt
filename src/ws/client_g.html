<html>
<head>
  <title>Simple client</title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>  

</head>

<body>
   <div id="table_div" style="height:600"></div>
   <div id="chart_div"></div> 
   <button id="change-btn">change columns</button>
   <button id="test-btn">test</button>
  <form onsubmit="onSubmit(); return false;">
    <input type="text" id="input">
    <input type="submit" value="Send">
    <button onclick="onCloseClick(); return false;">close</button>
  </form>
  <div id="log"></div>
  <script>
	$('#test-btn').click(function(){
		alert('hereee');
	});  
	
	var view = null;
	var data = null;
	var table= null;   
    var options = {allowHtml: true, sortColumn:1, 
    		showRowNumber: true, width: '100%', height: '100%'};
    
    var chartOptions = {
            width: 600,
            height: 400,
            legend: { position: 'top', maxLines: 3 },
            bar: { groupWidth: '75%' },
            isStacked: true,allowHtml: true,
         /*series: {
    			0:{color:'lightgreen'},
    			1:{color:'black'},
    			2:{color:'#1E90FF',},
    			}*/ 
    };
    
	google.load("visualization", "1.1", {packages:["corechart", 'table','gauge']});
	   //google.setOnLoadCallback(drawTable);
	google.setOnLoadCallback(init);
	

	
	
	function setValueAtRandomCell(value){
		data.setCell(getRandomInt(0, data.getNumberOfRows()-1), 
			getRandomInt(0, data.getNumberOfColumns()-1), value);
		table.draw(data);
	}
	
	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
	
	function setupFormatter(tableData){
	    var numF = new google.visualization.NumberFormat(
    		    {prefix: '$', pattern:'0.00', negativeColor: 'red', negativeParens: true});
	    var percentF = new google.visualization.NumberFormat(
	    		{pattern: '##.#%'})
	    var arrowF = new google.visualization.ArrowFormat();
        var barF = new google.visualization.BarFormat({width: 80,
			colorPositive: 'green', max:100 });       
    			    
    	var colorF = new google.visualization.ColorFormat();
    	colorF.addRange(-100, 0, 'white', 'red');
    	colorF.addRange(0, 100, 'white', 'blue');


		var colorGF = new google.visualization.ColorFormat();
		colorGF.addGradientRange(null, null, 'white', 'orange', 'blue');
	
	    	 	    
		    numF.format(data, 2);  //avg cost
		    numF.format(data, 3);  //market value
		    colorF.format(data, 6); // position
		    percentF.format(data, 7); //delta		
		    
		    numF.format(data, 10); // position delta
		    numF.format(data, 11); // position theta
		    numF.format(data, 12); // position gamma
		    colorGF.format(data, 13); //unreal p/l
		    barF.format(data, 14) //% gain loss
		
	}	   
	   

    var ws;
    var account = 'U8379890';
	
    function init() {

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:9001/");
   
      // Set event handlers.
      ws.onopen = function() {
        output("onopen");
        ws.send(JSON.stringify({event: 'event_tm_request_table_structure', target_resource:{'class': 'Portfolio'}, 'account': 'UU777'}));
        ws.send(JSON.stringify({event: 'event_tm_request_table_structure', target_resource:{'class': 'PortfolioColumnChartTM'}, 'account': 'UU777'}));
        
      };
      
      ws.onmessage = function(e) {
        // e.data contains received string.
        
        //output("onmessage: " + e.data);
        d1=  JSON.parse(e.data);
		console.log(d1.source);
		console.log(d1);
        
        if (d1.source.data == 'PortfolioColumnChartTM'){
        	console.log('skip...');
        	return;
        }
        if (d1.event == "event_tm_table_structure_changed"){
			data = new google.visualization.DataTable(d1.value);
			view = new google.visualization.DataView(data);

			view.setRows(view.getFilteredRows([{column: 15, test: function(value, row, column, table) {
		        return (value == 'HSI' || value == 'MHI') 
		    }}]));
    		setupFormatter(data);
			table = new google.visualization.Table(document.getElementById('table_div'));
			table.draw(view, options);
			output('number of rows: ' + data.getNumberOfRows());
           
        } else if (d1.event == 'event_tm_table_row_updated'){

			console.log(d1.value.row.toString()+ ':' + d1.value.row_values[0]['v']);
			for (var c=2; c < d1.value.row_values.length; c++){
				data.setCell(d1.value.row, c, d1.value.row_values[c]["v"]);

			}
			//data.setCell(d1.value.row, 1, d1.value.row_values[0]['v']);
			
			options.sortColumn = table.getSortInfo().column;
			table.draw(view, options);
//			table.draw(data);           

        } else if (d1.event == 'event_tm_table_row_inserted'){
        	var newRow = d1.value.row_values.map(function(x){
        		return x['v'];
        	});
        	output('adding new row: ' + newRow.toString());
        	data.addRow(newRow);
        	options.sortColumn = table.getSortInfo().column;
        	table.draw(view, options);
        }
        
      };
      
      ws.onclose = function() {
        output("onclose");
      };

      ws.onerror = function(e) {
        output("onerror");
        console.log(e)
      };

    }
    
    function handleTableChartEvents(){
    	
    	
    }
    
    
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }
    
    function onCloseClick() {
      ws.close();
    }
    
    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      log.innerHTML = escaped + "<br>" + log.innerHTML;
    }
	 
  </script>
</body>
</html>