<html>
<head>
  <title>Simple client</title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>  

</head>

<body>
   <div id="table_div"></div>
   <button id="change-btn">change columns</button>
   <button id="test-btn">test</button>
  <form onsubmit="onSubmit(); return false;">
    <input type="text" id="input">
    <input type="submit" value="Send">
    <button onclick="onCloseClick(); return false;">close</button>
  </form>
  <div id="log"></div>
  <script>
	$('#test-btn').click(function(){
		alert('hereee');
	});  
	
	var view = null;
	var data = null;
	var table= null;   
//        var options = {sortColumn:1, showRowNumber: true, width: '100%', height: '100%'};
        var options = {sort: 'disable', sortColumn:-1, showRowNumber: true, width: '100%', height: '100%'};
	   //google.charts.load('current', {'packages':['table']});
	   google.load("visualization", "1.1", {packages:["corechart", 'table','gauge']});
	   //google.setOnLoadCallback(drawTable);
	   google.setOnLoadCallback(init);
	

	
	
	function setValueAtRandomCell(value){
		data.setCell(getRandomInt(0, data.getNumberOfRows()-1), 
			getRandomInt(0, data.getNumberOfColumns()-1), value);
		table.draw(data);
	}
	
	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
	
	   
	function drawTable() {
	 
   	   data= new google.visualization.DataTable();
	   table = new google.visualization.Table(document.getElementById('table_div'));
	   table.draw(data, {sort: 'event', sortColumn:-1, showRowNumber: true, width: '100%', height: '100%'});
	 }
	   

    var ws;
	
	
	
    
    function init() {

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:9001/");
   
      // Set event handlers.
      ws.onopen = function() {
        output("onopen");
        ws.send(JSON.stringify({'request_for': 'init_data_table', 'request_handler': ''}));
      };
      
      ws.onmessage = function(e) {
        // e.data contains received string.
        
        //output("onmessage: " + e.data);
        d1=  JSON.parse(e.data);
        if (d1.event == "event_tm_table_structure_changed"){

			console.log(d1);
			data = new google.visualization.DataTable(d1.value);
			//view = new google.visualization.DataView(data);
			/*view.setRows(view.getFilteredRows([{column: 14, test: function(value, row, column, table) {
        return (value == 'HSI' || value == 'MHI') 
    }}]));*/
			table = new google.visualization.Table(document.getElementById('table_div'));
			table.draw(data, options);
			output('number of rows: ' + data.getNumberOfRows());
           
        } else if (d1.event == 'event_tm_table_row_updated'){

			console.log(d1.value.row.toString()+ ':' + d1.value.row_values[0]['v']);
			for (var c=2; c < d1.value.row_values.length; c++){
				data.setCell(d1.value.row, c, d1.value.row_values[c]["v"]);

			}
			data.setCell(d1.value.row, 1, d1.value.row_values[0]['v']);
			
			table.draw(data, options);
//			table.draw(data);           
//        	setValueAtRandomCell(getRandomInt(1000, 5000));
        }
        
      };
      
      ws.onclose = function() {
        output("onclose");
      };

      ws.onerror = function(e) {
        output("onerror");
        console.log(e)
      };

    }
    
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }
    
    function onCloseClick() {
      ws.close();
    }
    
    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      log.innerHTML = escaped + "<br>" + log.innerHTML;
    }
	 
  </script>
</body>
</html>
