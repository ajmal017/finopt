<html>
<head>
  <title>Simple client</title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>  

</head>

<body>
  <input type="radio" name='acct' id="acct" value="U9050568" checked="checked"> U9050568<br>
  <input type="radio" name='acct' id="acct" value="U8080985"> U8080985<br>
   <button id="reload_port">Reload Portfolio</button>
   <div id="table_div" style="height:600"></div>
   <div id="chart_div"></div> 
   <button id="change-btn">change columns</button>
   <button id="test-btn">test</button>
  <form onsubmit="onSubmit(); return false;">
    <input type="text" id="input">
    <input type="submit" value="Send">
    <button onclick="onCloseClick(); return false;">close</button>
  </form>
  <div id="log"></div>
  <script>
	
  
  	var account;
  	

    $(document).ready(function () {
    	
  		// retrieve the last saved preference 
	    var account = localStorage.getItem('account');
	    console.log('retrieving the account code from storage => ' + (account == null ? '<not found>' : account));
	    if (account == null){
	    	account = $('input[id=acct]:checked').val();
	    	
	    	
	    }
	    qs = "input[id=acct][value='" + account + "']"
	    document.querySelectorAll(qs)[0].checked=true;

	});
  
  
	$('#test-btn').click(function(){
		alert('hereee');
	});  
	$('#reload_port').click(function(){
		alert('Reloading portfolio...');
		
		// save the account number that was selected
		// so that it could be retrieved when the page
		// is reloaded later
	    localStorage.setItem('account', $('input[id=acct]:checked').val());

		if (ws != null){
			ws.close();
			location.reload();
		}
	});  

    var chartOptions = {
            width: 800,
            height: 500,
            legend: { position: 'right', maxLines: 3 },
            bar: { groupWidth: '75%' },
            isStacked: true,allowHtml: true,
         /*series: {
    			0:{color:'lightgreen'},
    			1:{color:'black'},
    			2:{color:'#1E90FF',},
    			}*/ 
    };
	var columnChart = {'view': null, 'data': null, 'chart': null, 'options': chartOptions};

    var tableOptions = {allowHtml: true, sortColumn:1, 
    		showRowNumber: true, width: '90%', height: '80%'};
	var tableChart = {'view': null, 'data': null, 'chart': null, 'options': tableOptions};
	

    

    
	google.load("visualization", "1.1", {packages:["corechart", 'table','gauge']});
	   //google.setOnLoadCallback(drawTable);
	google.setOnLoadCallback(init);
	

	
	

	
	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
	
	function setupFormatter(tableData){
	    var numF = new google.visualization.NumberFormat(
    		    {prefix: '$', pattern:'0.00', negativeColor: 'red', negativeParens: true});
	    var percentF = new google.visualization.NumberFormat(
	    		{pattern: '##.#%'})
	    var arrowF = new google.visualization.ArrowFormat();
        var barF = new google.visualization.BarFormat({width: 80,
			colorPositive: 'green', max:100 });       
    			    
    	var colorF = new google.visualization.ColorFormat();
    	colorF.addRange(-100, 0, 'white', 'red');
    	colorF.addRange(0, 100, 'white', 'blue');


		var colorGF = new google.visualization.ColorFormat();
		colorGF.addGradientRange(null, null, 'white', 'orange', 'blue');
	
	    	 	    
		    numF.format(tableChart.data, 2);  //avg cost
		    numF.format(tableChart.data, 3);  //market value
		    colorF.format(tableChart.data, 6); // position
		    percentF.format(tableChart.data, 7); //delta		
		    
		    numF.format(tableChart.data, 10); // position delta
		    numF.format(tableChart.data, 11); // position theta
		    numF.format(tableChart.data, 12); // position gamma
		    colorGF.format(tableChart.data, 13); //unreal p/l
		    barF.format(tableChart.data, 14) //% gain loss
		
	}	   
	   

    var ws;
	
    function init() {

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:9001/");
   
      // Set event handlers.
      ws.onopen = function() {
    	var account = $('input[id=acct]:checked').val();
    	  
    	  
        output("onopen account = " + account );
        
        ws.send(JSON.stringify({event: 'event_tm_request_table_structure', target_resource:{'class': 'Portfolio'}, 'account': account}));
        ws.send(JSON.stringify({event: 'event_tm_request_table_structure', target_resource:{'class': 'PortfolioColumnChartTM'}, 'account': account}));
        
      };
      
      ws.onmessage = function(e) {
        // e.data contains received string.
        
        //output("onmessage: " + e.data);
        d1=  JSON.parse(e.data);
		console.log(d1);

		
    	// 2019.1 if the messageis not intended 
	if (d1.event == 'event_tm_table_structure_changed' && d1.account != account) 
		return;
	else if (d1.event == 'event_tm_table_row_updated' && d1['value']['source']['account'] != account) 
		return;
		
		
        if (d1.event == "event_tm_table_structure_changed"){

        	
        	
			if (d1.source.class == 'Portfolio'){
				tableChart.data = new google.visualization.DataTable(d1.value);
				tableChart.view = new google.visualization.DataView(tableChart.data);
				tableChart.view.setRows(tableChart.view.getFilteredRows([{column: 15, test: function(value, row, column, table) {
			        return (value == 'HSI' || value == 'MHI')
			    }},
			    {column: 6, test: function(value, row, column, table) {
			        return (value != 0)
			    }},
			     
			    ]));



	    		setupFormatter(tableChart.data);
	    		tableChart.chart = new google.visualization.Table(document.getElementById('table_div'));
	    		tableChart.chart.draw(tableChart.view, tableChart.options);
				output('number of rows: ' + tableChart.data.getNumberOfRows());
				
			} else if (d1.source.class == 'PortfolioColumnChartTM'){
				columnChart.data = new google.visualization.DataTable(d1.value);
				console.log(d1.account);
				columnChart.view = new google.visualization.DataView(columnChart.data);
				columnChart.chart = new google.visualization.ColumnChart(
				        document.getElementById('chart_div'));
				columnChart.chart.draw(columnChart.view, columnChart.options);
			}
           
        } else if (d1.event == 'event_tm_table_row_updated'){

			console.log(d1.value.row.toString()+ ':' + d1.value.row_values[0]['v']);
			for (var c=2; c < d1.value.row_values.length; c++){
				tableChart.data.setCell(d1.value.row, c, d1.value.row_values[c]["v"]);

			}
			//data.setCell(d1.value.row, 1, d1.value.row_values[0]['v']);
			
			tableChart.options.sortColumn = tableChart.chart.getSortInfo().column;
			tableChart.chart.draw(tableChart.view, tableChart.options);
           

        } else if (d1.event == 'event_tm_table_row_inserted'){
        	var newRow = d1.value.row_values.map(function(x){
        		return x['v'];
        	});
        	output('adding new row: ' + newRow.toString());
        	data.addRow(newRow);
        	options.sortColumn = table.getSortInfo().column;
        	table.draw(view, options);
        } else if (d1.event == 'event_port_values_updated'){
        	
        	console.log(d1.value.port_values);
        }
        
      };
      
      ws.onclose = function() {
        output("onclose");
      };

      ws.onerror = function(e) {
        output("onerror");
        console.log(e)
      };

    }
    

    
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }
    
    function onCloseClick() {
     
      ws.close();
    }
    
    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      log.innerHTML = escaped + "<br>" + log.innerHTML;
    }
	 
  </script>
</body>
</html>
